# 云算力资源租用系统设计文档

## 一、系统整体类结构

### 1. 基础类

#### 1.1 Entity（实体基类）
- 所有实体类的基类，提供基本的ID和创建时间属性
- 提供序列化和反序列化接口

#### 1.2 Exception（异常基类）
- 自定义异常的基类
- 提供异常类型、错误信息和错误代码

### 2. 用户模块

#### 2.1 User（用户基类）
- 属性：ID、用户名、密码、姓名、余额、状态（激活/暂停）
- 方法：登录、修改信息、查询余额

#### 2.2 Student（学生类，继承自User）
- 特有属性：学号、专业

#### 2.3 Teacher（教师类，继承自User）
- 特有属性：工号、职称

#### 2.4 Admin（管理员类，继承自User）
- 特有属性：权限级别
- 特有方法：管理用户、管理资源、审核租用申请

#### 2.5 UserManager（用户管理器）
- 负责用户的注册、登录验证、信息管理
- 维护用户列表，提供用户查询功能

### 3. 资源模块

#### 3.1 Resource（资源基类）
- 属性：ID、名称、描述、状态（空闲/使用中）
- 方法：查询状态、更新状态

#### 3.2 CPUResource（CPU资源，继承自Resource）
- 特有属性：核心数、频率

#### 3.3 GPUResource（GPU资源，继承自Resource）
- 特有属性：型号、显存大小、计算能力

#### 3.4 StorageResource（存储资源，继承自Resource）
- 特有属性：容量、读写速度、类型（SSD/HDD）

#### 3.5 ResourceManager（资源管理器）
- 负责资源的添加、删除、修改、查询
- 维护资源列表，提供资源分配功能

### 4. 租用模块

#### 4.1 Rental（租用记录）
- 属性：ID、用户ID、资源ID、开始时间、结束时间、状态（申请中/审核通过/审核拒绝/使用中/已完成/已取消）、审核备注
- 方法：申请租用、取消租用、查询状态

#### 4.2 RentalManager（租用管理器）
- 负责租用申请的处理、状态更新、记录查询
- 维护租用记录列表，提供租用状态流转功能

### 5. 支付与计费模块

#### 5.1 Bill（账单）
- 属性：ID、租用ID、用户ID、资源ID、费用、生成时间、状态（已支付/未支付）
- 方法：计算费用、支付账单

#### 5.2 PricingRule（计费规则）
- 属性：资源类型、单位时间费用、最小计费单位、最长租用时间
- 方法：计算费用

#### 5.3 BillingManager（计费管理器）
- 负责账单生成、费用计算、余额扣除
- 维护账单列表和计费规则，提供账单查询功能

### 6. 通知模块

#### 6.1 Notification（通知）
- 属性：ID、用户ID、内容、时间、优先级、状态（已读/未读）
- 方法：标记已读、删除通知

#### 6.2 NotificationManager（通知管理器）
- 负责通知的生成、发送、查询、删除
- 维护通知列表，提供通知推送功能

### 7. 数据持久化模块

#### 7.1 DataManager（数据管理器）
- 负责数据的加载、保存、备份
- 提供序列化和反序列化接口

### 8. 系统模块

#### 8.1 System（系统类）
- 整合各个模块，提供统一的接口
- 负责系统初始化、运行、退出

#### 8.2 Menu（菜单类）
- 负责命令行界面的显示和交互
- 提供不同角色的菜单选项

## 二、数据持久化方案

### 1. 文件结构
- users.dat：存储用户信息
- resources.dat：存储资源信息
- rentals.dat：存储租用记录
- bills.dat：存储账单信息
- notifications.dat：存储通知信息
- logs.dat：存储系统日志
- config.dat：存储系统配置（如计费规则）

### 2. 序列化与反序列化
- 使用C++的二进制I/O流进行序列化和反序列化
- 每个实体类实现自己的序列化和反序列化方法
- 数据管理器负责统一的数据读写操作

### 3. 数据备份
- 定期将数据文件备份到backup目录
- 备份文件命名格式：[原文件名]_[备份时间].bak

## 三、主要业务流程

### 1. 用户注册与登录流程
1. 用户选择注册类型（学生/教师）
2. 输入用户名、密码、姓名等信息
3. 系统验证信息有效性，创建用户对象
4. 将用户信息保存到users.dat
5. 登录时验证用户名和密码，根据用户类型加载相应菜单

### 2. 资源租用流程
1. 用户浏览可用资源列表
2. 选择要租用的资源，指定租用时间
3. 系统检查用户余额和资源状态
4. 创建租用申请，状态设为"申请中"
5. 管理员审核申请，决定通过或拒绝
6. 审核通过后，资源状态变为"使用中"，租用状态变为"使用中"
7. 租用结束后，自动生成账单，扣除用户余额，资源状态变为"空闲"，租用状态变为"已完成"

### 3. 账单生成与支付流程
1. 租用结束时，系统根据租用时长和计费规则计算费用
2. 创建账单对象，关联到相应的租用记录
3. 从用户余额中扣除费用
4. 如余额不足，生成高优先级通知

### 4. 通知生成与处理流程
1. 系统监控租用状态、余额变化等事件
2. 发生异常或重要事件时，生成相应通知
3. 用户登录时，系统检查未读通知并显示
4. 用户可标记通知为已读或删除通知

## 四、异常处理机制

### 1. 异常类层次结构
- SystemException：系统异常基类
  - FileException：文件操作异常
  - DataException：数据处理异常
- BusinessException：业务异常基类
  - UserException：用户相关异常
  - ResourceException：资源相关异常
  - RentalException：租用相关异常
  - BillingException：计费相关异常

### 2. 异常处理策略
- 使用try-catch捕获并处理异常
- 记录异常信息到日志文件
- 对用户友好的错误提示
- 关键操作的数据回滚机制

### 3. 常见异常处理
- 余额不足：抛出BillingException，取消租用申请，通知用户
- 资源不可用：抛出ResourceException，提示用户选择其他资源
- 用户状态异常：抛出UserException，限制用户操作
- 文件读写错误：抛出FileException，尝试恢复数据，必要时使用备份

## 五、安全与权限设计

### 1. 密码安全
- 密码输入不显示，使用星号代替
- 密码存储采用简单加密（考虑到大一学生水平，不使用复杂的哈希算法）

### 2. 操作权限
- 学生：查询资源、申请租用、查看个人租用记录和账单
- 教师：与学生相同，但租用优先级更高
- 管理员：管理用户、管理资源、审核租用申请、设置计费规则

### 3. 日志记录
- 记录所有关键操作，包括登录、注册、租用、审核等
- 日志包含操作时间、操作用户、操作类型、操作结果

## 六、命令行界面设计

### 1. 主菜单
- 登录
- 注册
- 退出

### 2. 学生/教师菜单
- 个人信息管理
- 余额查询
- 资源浏览
- 租用申请
- 租用记录查询
- 账单查询
- 通知查看
- 退出登录

### 3. 管理员菜单
- 用户管理
- 资源管理
- 租用审核
- 租用记录查询
- 账单管理
- 计费规则设置
- 系统日志查看
- 退出登录

### 4. 交互方式
- 数字选择菜单选项
- 清晰的提示信息
- 操作确认机制
- 分页显示长列表
